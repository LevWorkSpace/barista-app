<aura:component controller="NewBillController" description="NewBill" implements="flexipage:availableForAllPageTypes,force:appHostable">
    <aura:attribute name="cache" type="Integer"/>
    <aura:attribute name="openCalc" type="Boolean" default="false"/>
    <aura:attribute name="selectedProducts" type="List" default="[]"/>
    <aura:attribute name="bill" type="Bill__c" default="{'totalPrice' : 0, 'discount' : 0, 'totalPriceWithDiscount' : 0}"/>
    <lightning:overlayLibrary aura:id="popuplib"/>

    <aura:handler name="productSelected" event="c:ProductSelected" action="{!c.handleProductSelected}"/>

    <lightning:card title="New Bill" aura:Id="card" class="bill-card">

        <aura:set attribute="actions">
            <lightning:button label="Add Product" onclick="{!c.openProductSearch}" class="slds-p-around_medium"/>
        </aura:set>

        <aura:if isTrue="{!v.selectedProducts.length > 0}">
            <div class="slds-scrollable">
            <table class="slds-table slds-table_cell-buffer slds-table_bordered slds-no-row-hover product-table">
                <thead>
                    <tr class="slds-line-height_reset">
                        <th class="slds-truncate">Product</th>
                        <th class="slds-truncate">Cost</th>
                        <th class="slds-truncate">Amount</th>
                        <th class="slds-truncate">Discount</th>
                        <th class="slds-truncate">Total</th>
                    </tr>
                </thead>
                <tbody>
                    <aura:iteration items="{!v.selectedProducts}" var="selectedProduct" indexVar="rowIndex">
                        <tr class="slds-hint-parent">
                            <td class="slds-truncate">
                                {!selectedProduct.name}
                                <div class="slds-text-body_small product-description">{!selectedProduct.description}</div>
                            </td>
                            <td class="slds-truncate"><c:OutputPrice price="{!selectedProduct.cost}"/></td>
                            <td class="slds-truncate">
                                <div class="slds-button-group">
                                    <aura:if isTrue="{!selectedProduct.amount == 1}">
                                        <a onclick="{!c.deleteFromBill}" data-index="{!rowIndex}" class="icon-links">
                                            <lightning:icon iconName="utility:clear" size="medium" alternativeText="delete" class="slds-float--right"/>
                                        </a>
                                        <aura:set attribute="else">
                                            <a onclick="{!c.minusAmount}" data-index="{!rowIndex}" class="icon-links">
                                                <lightning:icon iconName="utility:dash" size="medium" alternativeText="minus" class="slds-float--right"/>
                                            </a>
                                        </aura:set>
                                    </aura:if>
                                    <ui:outputNumber value="{!selectedProduct.amount}" class="slds-text-align_center amount"/>
                                    <a onclick="{!c.plusAmount}" data-index="{!rowIndex}" class="icon-links">
                                        <lightning:icon iconName="utility:add" size="medium" alternativeText="plus"/>
                                    </a>
                                </div>
                            </td>
                            <td class="slds-truncate">
                                <lightning:select onchange="{!c.recalculateTotal}" value="{!selectedProduct.discount}" class="input-discount">
                                    <option value="0">0%</option>
                                    <option value="10">10%</option>
                                    <option value="100">free</option>
                                </lightning:select>
                            </td>
                            <td class="slds-truncate"><c:OutputPrice price="{!selectedProduct.totalCost}"/></td>
                        </tr>
                    </aura:iteration>
                </tbody>
            </table>
            </div>
        </aura:if>

        <aura:set attribute="footer">
            <aura:if isTrue="{!v.selectedProducts.length > 0}">
                <section class="slds-grid slds-grid_vertical footer-total">
                    <div class="slds-m-around_xx-small">
                        <label class="slds-form-element__label slds-no-flex">Total Price:</label>
                        <c:OutputPrice price="{!v.bill.totalPrice}"/>
                    </div>
                    <div class="slds-m-around_xx-small centered-result">
                        <label class="slds-form-element__label slds-no-flex">Bill Discount:</label>
                        <lightning:select onchange="{!c.recalculateTotal}" value="{!v.bill.discount}" class="input-discount">
                            <option value="0">0%</option>
                            <option value="30">30%</option>
                        </lightning:select>
                    </div>
                    <div class="slds-m-around_xx-small">
                        <label class="slds-form-element__label slds-no-flex">Total Price with Discount:</label>
                        <span class="total-price"><c:OutputPrice price="{!v.bill.totalPriceWithDiscount}"/></span>
                        <a onclick="{!c.toggleCalc}" class="slds-p-around_small">
                            <lightning:icon iconName="utility:money" size="medium" alternativeText="toggleCalc"/>
                        </a>
                    </div>
                    <aura:if isTrue="{!v.openCalc}">
                        <div class="slds-m-around_xx-small">
                            <label class="slds-form-element__label slds-no-flex">Cache:</label>
                            <lightning:input type="number" label="" value="{!v.cache}" class="input-discount"/>
                        </div>
                        <div class="slds-m-around_xx-small">
                            <label class="slds-form-element__label slds-no-flex">Change:</label>
                            <c:OutputPrice price="{!v.cache ? v.cache - v.bill.totalPriceWithDiscount : null}"/>
                        </div>
                    </aura:if>
                    <div class="slds-m-around_xx-small">
                        <lightning:button label="Confirm Bill" onclick="{!c.saveBill}" variant="brand" class="slds-p-around_medium"/>
                    </div>
                </section>
            </aura:if>
        </aura:set>

    </lightning:card>

    <c:ProductSearch aura:Id="productSearch"/>
    
</aura:component>